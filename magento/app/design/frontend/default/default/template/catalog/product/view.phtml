<?php
/**
 * Magento
 *
 * NOTICE OF LICENSE
 *
 * This source file is subject to the Academic Free License (AFL 3.0)
 * that is bundled with this package in the file LICENSE_AFL.txt.
 * It is also available through the world-wide-web at this URL:
 * http://opensource.org/licenses/afl-3.0.php
 * If you did not receive a copy of the license and are unable to
 * obtain it through the world-wide-web, please send an email
 * to license@magentocommerce.com so we can send you a copy immediately.
 *
 * DISCLAIMER
 *
 * Do not edit or add to this file if you wish to upgrade Magento to newer
 * versions in the future. If you wish to customize Magento for your
 * needs please refer to http://www.magentocommerce.com for more information.
 *
 * @category    design
 * @package     base_default
 * @copyright   Copyright (c) 2012 Magento Inc. (http://www.magentocommerce.com)
 * @license     http://opensource.org/licenses/afl-3.0.php  Academic Free License (AFL 3.0)
 */

/**
 * Product view template
 *
 * @see Mage_Catalog_Block_Product_View
 * @see Mage_Review_Block_Product_View
 */
?>
<?php
$_helper = $this->helper('catalog/output');
$_product = $this->getProduct();
$_tiProduct = $_product->getTiProduct();
$_description = $_product->getDescription();
$_ad = $this->getAdditionalData();

$productAttributeSetName = $_product->getAttributeSetName();


// Get the Bill of Materials
$billOfMaterials = json_decode($_product->getBillOfMaterials(), true);

// Get the service kits
$serviceKits = json_decode($_product->getServiceKits(), true);

// Get the usages
$whereUsed = json_decode($_product->getWhereUsed(), true);

// Get the interchanges SKUs, tiPartSkuArray is a subset of this
$interchangeSkuArray = $_product->getInterchanges() ? explode(',', $_product->getInterchanges()) : array();


// Load the interchange products and sort them.
$interchangeSkuProductMap = array();
foreach ($interchangeSkuArray as $interchangeSku) {
    $interchangeProduct = Mage::getModel('catalog/product')->loadByAttribute('sku', $interchangeSku);

    // Make sure interchange product exists
    if ($interchangeProduct) {
        $interchangeSkuProductMap[$interchangeSku] = $interchangeProduct;
    }
}

// Sorts products by part number
function usortByPartNumberPredicate($a, $b)
{
    return strcmp($a->getPartNumber(), $b->getPartNumber());
}

uasort($interchangeSkuProductMap, 'usortByPartNumberPredicate');
?>
<script type="text/javascript">
    var optionsPrice = new Product.OptionsPrice(<?php echo $this->getJsonConfig() ?>);
</script>
<div id="messages_product_view"><?php echo $this->getMessagesBlock()->getGroupedHtml() ?></div>
<div class="product-view">
<div class="product-essential">
    <form action="<?php echo $this->getSubmitUrl($_product) ?>" method="post"
        id="product_addtocart_form"<?php if ($_product->getOptions()): ?> enctype="multipart/form-data"<?php endif; ?>>
        <div class="no-display">
            <input type="hidden" name="product" value="<?php echo $_product->getId() ?>"/>
            <input type="hidden" name="related_product" id="related-products-field" value=""/>
        </div>

        <div class="product-shop">
            <div class="product-name">
                <h1><?php echo($_product->getName() ? $_helper->productAttribute($_product, $_product->getName(), 'name') : 'No Name') ?></h1>
            </div>

            <?php echo $this->getReviewsSummaryHtml($_product, false, true) ?>
            <?php echo $this->getChildHtml('alert_urls') ?>
            <?php echo $this->getChildHtml('product_type_data') ?>
            <?php echo $this->getTierPriceHtml() ?>
            <?php echo $this->getChildHtml('extrahint') ?>

            <div class="add-to-box">
                <?php if ($_product->isSaleable() && $_product->isTurboInternational() || $_tiProduct): ?>
                    <?php echo $this->getChildHtml('addtocart'); ?>
                    <?php if ($this->helper('wishlist')->isAllow() || $_compareUrl = $this->helper('catalog/product_compare')->getAddUrl($_product)): ?>
                        <span class="or"><?php echo $this->__('OR') ?></span>
                    <?php endif; ?>
                <?php endif; ?>
                <?php echo $this->getChildHtml('addto') ?>
            </div>

            <!-- Email a friend -->
            <?php if ($this->canEmailToFriend()): ?>
                <p class="email-friend"><a
                        href="<?php echo $this->helper('catalog/product')->getEmailToFriendUrl($_product) ?>"><?php echo $this->__('Email to a Friend') ?></a>
                </p>
            <?php endif; ?>

            <?php if ($_product->getShortDescription()): ?>
                <div class="short-description">
                    <h2><?php echo $this->__('Quick Overview') ?></h2>

                    <div
                        class="std"><?php echo $_helper->productAttribute($_product, nl2br($_product->getShortDescription()), 'short_description') ?></div>
                </div>
            <?php endif; ?>

            <?php echo $this->getChildHtml('other'); ?>

            <?php if ($_product->isSaleable() && $this->hasOptions()): ?>
                <?php echo $this->getChildChildHtml('container1', '', true, true) ?>
            <?php endif; ?>

        </div>

        <div class="product-img-box">
            <?php echo $this->getChildHtml('media') ?>
        </div>

        <div class="clearer"></div>

        <?php if ($_product->isSaleable() && $this->hasOptions()): ?>
            <?php echo $this->getChildChildHtml('container2', '', true, true) ?>
        <?php endif; ?>

    </form>
    <script type="text/javascript">
        //<![CDATA[
        var productAddToCartForm = new VarienForm('product_addtocart_form');
        productAddToCartForm.submit = function (button, url) {
            if (this.validator.validate()) {
                var form = this.form;
                var oldUrl = form.action;

                if (url) {
                    form.action = url;
                }
                var e = null;
                try {
                    this.form.submit();
                } catch (e) {
                }
                this.form.action = oldUrl;
                if (e) {
                    throw e;
                }

                if (button && button != 'undefined') {
                    button.disabled = true;
                }
            }
        }.bind(productAddToCartForm);

        productAddToCartForm.submitLight = function (button, url) {
            if (this.validator) {
                var nv = Validation.methods;
                delete Validation.methods['required-entry'];
                delete Validation.methods['validate-one-required'];
                delete Validation.methods['validate-one-required-by-name'];
                // Remove custom datetime validators
                for (var methodName in Validation.methods) {
                    if (methodName.match(/^validate-datetime-.*/i)) {
                        delete Validation.methods[methodName];
                    }
                }

                if (this.validator.validate()) {
                    if (url) {
                        this.form.action = url;
                    }
                    this.form.submit();
                }
                Object.extend(Validation.methods, nv);
            }
        }.bind(productAddToCartForm);

        //]]>
    </script>
</div>
<!-- Necessary jQueryUI Tabs script -->
<script type="text/javascript">
    jQuery(function () {
        jQuery("#tabs").tabs();
    });
</script>
<script type="text/javascript">
    // highlights table rows and columns
    jQuery(function() {

        jQuery("table").delegate('td, th','mouseover mouseleave', function(e) {
            // pick the closest table and rows so other tables are not affected
            var $table = jQuery(this).closest("table");
            var $row = jQuery(this).closest("tr");

            // check to make sure div has the correct class
            if ($table.closest("div").hasClass("matrix-data")) {
                if (e.type == 'mouseover') {
                    // do not highlight header row
                    if (!(jQuery(this).is("th"))) {
                        $row.addClass("hover");
                    }

                    var ind = jQuery(this).index();
                    // do not highlight first column
                    if (ind > 0) {
                        jQuery('td:nth-child(' + (ind + 1) + ')').addClass("hover");
                        jQuery('th:nth-child(' + (ind + 1) + ')').addClass("hover");
                    }
                } else {
                    // do not do if header row
                    if (!(jQuery(this).is("th"))) {
                        $row.removeClass("hover");
                    }

                    var ind = jQuery(this).index();
                    // do not do if first column
                    if (ind > 0) {
                        jQuery('td:nth-child(' + (ind + 1) + ')').removeClass("hover");
                        jQuery('th:nth-child(' + (ind + 1) + ')').removeClass("hover");
                    }
                }
            }
        });

    });
</script>

<div class="product-collateral">
    <div id="tabs" style="font-size: 97%;">
        <ul>
            <li><a href="#tabs-product-information">Product Information</a></li>
            <li><a href="#tabs-interchangeable-parts">Interchangeable Parts</a></li>
            <li><a href="#tabs-bill-of-materials">Bill of Materials</a></li>
            <li><a href="#tabs-application-detail">Application Detail</a></li>
            <li><a href="#tabs-where-used">Where Used</a></li>
            <li><a href="#tabs-kit-matrix">Kit Matrix</a></li>
        </ul>
        
        <!-- Product Information -->
        <div id="tabs-product-information">
            <div class="box-collateral">
                <h2><?php echo $this->__('Product Information') ?></h2>
                <table class="data-table" id="product-information-specs-table">
                    <col width="25%"/>
                    <col/>
                    <tbody>
                    <tr>
                        <th class="label">Part Type</th>
                        <td class="data"><?php echo $_product->getAttributeText('part_type'); ?></td>
                    </tr>
                    <tr>
                        <th class="label">Manufacturer</th>
                        <td class="data"><?php echo $_product->getAttributeText('manufacturer'); ?></td>
                    </tr>
                    <tr>
                        <th class="label">Part Number</th>
                        <td class="data"><?php echo $_product->getPartNumber(); ?></td>
                    </tr>
                    <tr>
                        <th class="label">Name</th>
                        <td class="data"><?php echo $_product->getName(); ?></td>
                    </tr>
                    <tr>
                        <th class="label">Description</th>
                        <td class="data"><?php echo $this->helper('catalog/output')->productAttribute($this->getProduct(), $_description, 'description') ?></td>
                    </tr>
                    </tbody>
                </table>
            </div>
            <?php foreach ($this->getChildGroup('detailed_info', 'getChildHtml') as $alias => $html): ?>
                <?php if ($alias != 'description'): ?>
                    <div class="box-collateral <?php echo "box-{$alias}" ?>">
                        <?php if ($title = $this->getChildData($alias, 'title')): ?>
                            <h2><?php echo $this->escapeHtml($title); ?></h2>
                        <?php endif; ?>
                        <?php echo $html; ?>
                    </div>
                <?php endif; ?>
            <?php endforeach; ?>

            <?php

            switch ($productAttributeSetName):
                case 'Turbine Wheel': ?>
                    <div class="box-collateral">
                        <h2><?php echo $this->__('Dimensions Measurement Legend') ?></h2>
                        <img src="/skin/frontend/default/default/images/turbine_wheel_dimensions.gif" alt="Turbine Wheel Dimensions Legend"/>
                    </div>
                    <?php break; ?>
                <?php case 'Compressor Wheel': ?>
                <div class="box-collateral">
                    <h2><?php echo $this->__('Dimensions Measurement Legend') ?></h2>
                    <img src="/skin/frontend/default/default/images/compressor_wheel_dimensions.png" alt="Compressor Wheel Dimensions Legend"/>
                </div>
                <?php break; ?>
            <?php case 'Backplate': ?>
                <div class="box-collateral">
                    <h2><?php echo $this->__('Dimensions Measurement Legend') ?></h2>
                    <img src="/skin/frontend/default/default/images/backplate_dimensions.png" alt="Backplate Dimensions Legend"/>
                </div>
                <?php break; ?>
            <?php endswitch ?>
            
            <?php if ($productAttributeSetName == "Cartridge"
                   || $productAttributeSetName == "Turbo"): ?>
            <div class="box-collateral">
                <h2><?php echo $this->__('Service Kits') ?></h2>
                <table class="data-table" id="service-kits">
                    <tr>
                        <th><strong>OE Part #</strong></th>
                        <th><strong>TI Part #</strong></th>
                        <th><strong>Description</strong></th>
                        <th><strong>Price</strong></th>
                    </tr>
                    <?php foreach ($serviceKits as $serviceKit):

                        $serviceKitProduct = Mage::getModel('catalog/product')->loadByAttribute('sku', $serviceKit['sku']);

                        // Load the TI product
                        $serviceKitTiProduct = null;

                        if (!empty($serviceKit['tiSku'])) {
                            $serviceKitTiProduct = Mage::getModel('catalog/product')->loadByAttribute('sku', $serviceKit['tiSku']);
                        }
                        ?>

                        <tr>
                            <!-- OE part # -->
                            <td>
                                <a href="<?php echo $serviceKitProduct->getProductUrl(); ?>">
                                    <?php echo $serviceKit['partNumber']?>
                                </a>
                            </td>

                            <!-- TI Part # -->
                            <td>
                                <?php if($serviceKitTiProduct): ?>
                                    <a href="<?php echo $serviceKitTiProduct->getProductUrl() ?>">
                                        <?php echo $serviceKit['tiPartNumber']; ?>
                                    </a>
                                <?php endif; ?>
                            </td>

                            <!-- Description -->
                            <td><?php echo $serviceKit['description']; ?></td>

                            <!-- Price -->
                            <td>
                                <?php if ($serviceKitTiProduct) {
                                    echo Mage::helper('core')->currency($serviceKitTiProduct->getFinalPrice());
                                } else {
                                    echo Mage::helper('core')->currency($serviceKitProduct->getFinalPrice());
                                }
                                ?>
                            </td>
                        </tr>
                    <?php endforeach; ?>
                </table>
            </div>
            <?php endif; ?>
        </div>
        <!-- Kit Matrix Testing -->
            <?php
                // order kits ascending by part number

                // get all components for all kits into an array of arrays. 
                // array(kit => bom_array([] => array(alt_part_sku => value, ti_part_sku => value, sku => value, quantity => value)))
                $kitMatrixComponents = array();
                foreach ($serviceKits as $serviceKit):
                    // define kit sku
                    $kitSku = $serviceKit['kitSku'][0];
                    $allKits[] = $kitSku;

                    // Get the Bill of Materials
                    $KitMatrixProduct = Mage::getModel('catalog/product')->loadByAttribute('sku', $kitSku);
                    $kitMatrixBillOfMaterials = json_decode($KitMatrixProduct->getBillOfMaterials(), true);

                    // build array of arrays
                    $kitMatrixComponents[$kitSku] = $kitMatrixBillOfMaterials;
                endforeach;
                $allUniqueKits = array_unique($allKits);
                asort($allUniqueKits);

                // create array of unique components from the BOM
                $uniqueComponents = array();
                $componentKitQty = array();
                // loop through each kit
                foreach ($kitMatrixComponents as $kitSku => $kitMatrixBillOfMaterials):
                    // loop through each BOM
                    foreach ($kitMatrixBillOfMaterials as $kitMatrixBomItem):
                        $allKitComponents[] = $kitMatrixBomItem[sku];

                        // create array of arrays of component and kit qty. array(component => array(kit => qty))
                        $componentKitQty[$kitMatrixBomItem[sku]][$kitSku] = $kitMatrixBomItem[quantity];
                    endforeach;
                endforeach;
                $uniqueComponents = array_unique($allKitComponents);
                asort($uniqueComponents);

                // get collection of kit products
                $kitCollection = Mage::getModel('catalog/product')->getCollection()
                    ->addAttributeToSelect('part_number')
                    ->setOrder('part_number', 'ASC')
                    ->addFieldToFilter('sku', $allUniqueKits);

                // get collection of component products
                $componentCollection = Mage::getModel('catalog/product')->getCollection()
                    ->addAttributeToSelect('part_number')
                    ->setOrder('part_number', 'ASC')
                    ->addFieldToFilter('sku', $uniqueComponents);
            ?>
            <div id="tabs-kit-matrix" class="box-collateral matrix-data">
                <h2><?php echo $this->__('Kit Matrix') ?></h2>

                <table class="data-table" id="kit-matrix">
                    <!--table header row   -->
                    <tr>
                        <!--for th element is blank because it is the upper left cell   -->
                        <th></th>
                        <?php
                            // loop through and crate a column for each kit
                            foreach ($kitCollection as $kit):
                        ?>
                                <th class="label">
                                    <div class="vertical-text"><div class="vertical-text__inner">
                                        <a href="<?php echo $kit->getProductUrl(); ?>">
                                            <?php echo $kit->getPartNumber() ?>
                                    </div></div>
                                    </a>
                                </th>
                        <?php
                            endforeach;
                        ?>
                    </tr>
                    <!-- row for each component -->
                        <?php
                            foreach ($componentCollection as $component):
                                // first few columns will be part number and maybe other static info
                        ?>
                                <tr>
                                    <td>
                                        <a href="<?php echo $component->getProductUrl(); ?>">
                                            <?php echo $component->getPartNumber() ?>
                                        </a>
                                    </td>
                        <?php
                                // remaining table cells are dynamic: one for each kit column qty
                                foreach ($allUniqueKits as $kit):
                                    // see if qty exists for component in kit bom
                                    $componentKitQtyValue = $componentKitQty[$component->getSku()][$kit];
                                    echo "<td>";
                                    echo $componentKitQtyValue;
                                    echo "</td>";
                                endforeach;
                                echo "</tr>";
                            endforeach;
                        ?>

                </table>
            </div>

        <!-- Interchangeable Parts -->
        <div id="tabs-interchangeable-parts" class="box-collateral">
            <h2><?php echo $this->__('Interchangeable Parts') ?></h2>
            <table class="data-table" id="interchangeable-parts-specs-table">
                <col width="25%"/>
                <col/>
                <tbody>
                <tr>
                    <th class="label">Part Number</th>
                    <th class="label">Manufacturer</th>
                </tr>
                <?php if (count($interchangeSkuArray)): ?>
                    <?php foreach ($interchangeSkuProductMap as $interchangeSku => $interchangeProduct): ?>
                        <tr>
                            <td class="data">
                                <a href="<?php echo $interchangeProduct->getProductUrl(); ?>"><?php echo $interchangeProduct->getPartNumber() ?></a>
                            <td class="data"><?php echo $interchangeProduct->getAttributeText('manufacturer'); ?></td>
                        </tr>
                    <?php endforeach; ?>
                <?php else: ?>
                    <tr>
                        <td colspan="2"><?php echo $this->__('No Interchangeable Parts') ?></td>
                    </tr>
                <?php endif; ?>
                </tbody>
            </table>
        </div>
        
        <!-- Bill of Materials -->
        <div id="tabs-bill-of-materials" class="box-collateral">
            <h2><?php echo $this->__('Bill of Materials') ?></h2>
            <table class="data-table" id="bill-of-materials">
                <tr>
                    <th><strong>Part Type</strong></th>
                    <th><strong>OE Part #</strong></th>
                    <th><strong>TI Part #</strong></th>
                    <th><strong>Name</strong></th>
                    <th><strong>Qty Per Set</strong></th>
                    <th><strong>Price</strong></th>
                </tr>

                <?php foreach ($billOfMaterials as $bomItem): ?>
                    <?php
                    $bomItemProduct = Mage::getModel('catalog/product')->loadByAttribute('sku', $bomItem['sku']);
                    $bomItemTiProduct = null;
                    ?>

                    <tr>
                        <td><?php echo $bomItemProduct->getAttributeText('part_type'); ?></td>
                        <td><?php echo '<a href="' . $bomItemProduct->getProductUrl() . '">' . $bomItemProduct->getPartNumber() . '</a>'; ?></td>
                        <td><?php
                            foreach ($bomItem['ti_part_sku'] as $idx => $tiPartSku) {
                                
                                // Get the interchange product
                                if ($tiPartSku == $bomItem['sku']) {
                                    $bomItemInterchangeProduct = $bomItemProduct; // Same as the bom item
//                                } elseif ($bomItemTiProduct && $bomItemTiProduct->getSku() == $tiPartSku) {
//                                    $bomItemInterchangeProduct = $bomItemProduct; // Same as the bom item TI product
                                } else {
                                    $bomItemInterchangeProduct = Mage::getModel('catalog/product')->loadByAttribute('sku', $tiPartSku);
                                }
                                
                                // Skip invalid products
                                if (!$bomItemInterchangeProduct) {
                                    continue;
                                }
                                
                                // Use the first TI product for pricing
                                if (!$bomItemTiProduct) {
                                    $bomItemTiProduct = $bomItemInterchangeProduct;
                                }
                                
                                echo '<a href="' . $bomItemInterchangeProduct->getProductUrl() . '">' . $bomItemInterchangeProduct->getPartNumber() . '</a>';

                                // Add commas between items
                                if ($idx+1 < count($bomItem['ti_part_sku'])) {
                                    echo ", ";
                                }
                            }?>
                        </td>
                        <td>
                            <?php if ($bomItemProduct->getId()): ?>
                                <a href="<?php echo $bomItemProduct->getProductUrl() ?>"><?php echo $bomItemProduct->getName() ?></a>
                            <?php else: ?>
                                <?php echo $bomItem['sku'] ?>
                            <?php endif; ?>
                        </td>
                        <td><?php echo $bomItem['quantity']; ?></td>
                        <td>
                            <?php if (Mage::getSingleton('customer/session')->isLoggedIn()): ?>
                                <?php
                                if ($bomItemTiProduct) {
                                    echo Mage::helper('core')->currency($bomItemTiProduct->getFinalPrice());
                                }
                                ?>
                            <?php else: ?>
                              <a href="<?php echo $this->getUrl('customer/account/login'); ?>">Login for price</a>
                            <?php endif; ?>
                        </td>

                    </tr>
                <?php endforeach; ?>
            </table>
        </div>

        <!-- Application Detail -->
        <div id="tabs-application-detail" class="box-collateral">
            <h2><?php echo $this->__('Application Detail') ?></h2>
            <table class="data-table" id="application_detail">
                <tr>
                    <th><strong>Make</strong></th>
                    <th><strong>Model</strong></th>
                    <th><strong>Year</strong></th>
                    <th><strong>Engine Size</strong></th>
                    <th><strong>Fuel</strong></th>
                </tr>

                <?php $appDetailRows = explode("||", $_product->getApplicationDetail()); ?>

                <?php foreach ($appDetailRows as $appDetailRowString): ?>
                    <?php $appRow = explode("!!", $appDetailRowString); ?>
                    <?php if (count($appRow) == 5): ?>
                        <tr>
                            <?php foreach ($appRow as $ap): ?>
                                <td class="data"><?php echo $ap; ?></td>
                            <?php endforeach; ?>
                        </tr>
                    <?php endif; ?>
                <?php endforeach; ?>
            </table>
        </div>
        
        <!-- Where Used -->
        <div id="tabs-where-used" class="box-collateral">
            <h2><?php echo $this->__('Where Used') ?></h2>
            <table class="data-table" id="where-used">
                <tr>
                    <?php switch($productAttributeSetName):
                              case "Turbo": ?>
                        <th><strong>OE Part #</strong></th>
                        <th><strong>Manufacturer</strong></th>
                        <th><strong>Part Type</strong></th>
                        <?php break; ?>
                        
                        <?php case "Cartridge": ?>
                        <th><strong>Turbo OE Part #</strong></th>
                        <th><strong>Manufacturer</strong></th>
                        <th><strong>Turbo Type</strong></th>
                        <?php break; ?>
                        
                        <?php default: ?>
                        <th><strong>Cartridge OE Part #</strong></th>
                        <th><strong>TI Part #</strong></th>
                        <th><strong>Manufacturer</strong></th>
                        <th><strong>Turbo OE Part #</strong></th>
                        <th><strong>Price</strong></th>
                        <?php break; ?>
                    <?php endswitch; ?>
                    
                </tr>

                <?php foreach ($whereUsed as $usage): ?>
                    <?php
                        $usageProduct = Mage::getModel('catalog/product')->loadByAttribute('sku', $usage['sku']);
                    ?>

                    <tr>
                        <!-- OE part # -->
                        <td>
                            <a href="<?php echo $usageProduct->getProductUrl(); ?>">
                                <?php echo $usage['partNumber']?>
                            </a>
                        </td>
                        
                        <!-- TI Part # -->
                        <?php if ($productAttributeSetName != "Turbo"
                               && $productAttributeSetName != "Cartridge"): ?>
                        <td>
                            <?php if (!empty($usage['tiSku'])): ?>
                                <?php $usageTiProduct = Mage::getModel('catalog/product')->loadByAttribute('sku', $usage['tiSku']); ?>
                                <?php if ($usageTiProduct): ?>
                                    <a href="<?php echo $usageTiProduct->getProductUrl() ?>">
                                        <?php echo $usage['tiPartNumber']; ?>
                                    </a>
                                <?php endif; ?>
                            <?php endif; ?>
                        </td>
                        <?php endif; ?>
                        
                        <!-- Manufacturer -->
                        <td>
                            <?php echo $usage['manufacturer']; ?>
                        </td>
                        
                        <!-- Part Type-specific; turbo = partType, cartridge = turbo type; else turbo part numbers -->
                        <td>
                            <?php
                            switch($productAttributeSetName) {
                                case "Turbo":
                                    echo $usage['partType'];
                                    break;
                                case 'Cartridge':
                                    echo $usage['turboType'];
                                    break;
                                default:
                                    echo join(', ', $usage['turboPartNumbers']);
                            }
                            ?>
                        </td>
                        
                        <!-- Price -->
                        <?php if ($productAttributeSetName != "Turbo"
                               && $productAttributeSetName != "Cartridge"): ?>
                               
                            <td>
                                <?php if (!empty($usage['tiSku']) && $usageTiProduct) {
                                    echo Mage::helper('core')->currency($usageTiProduct->getFinalPrice());
                                } elseif ($usageProduct->isTurboInternational()) {
                                    echo Mage::helper('core')->currency($usageProduct->getFinalPrice());
                                }
                                ?>
                            </td>
                            
                        <?php endif; ?>
                    </tr>
                <?php endforeach; ?>
            </table>
        </div>
    </div>

    <div style="margin-top: 5px;">
        <?php echo $this->getLayout()->createBlock('cms/block')->setBlockId('product_custom_options')->toHtml() ?>
        <?php echo $this->getChildHtml('upsell_products') ?>
        <?php echo $this->getChildHtml('product_additional_data') ?>
    </div>
</div>
</div>

<script type="text/javascript">decorateTable('product-information-specs-table')</script>
<script type="text/javascript">decorateTable('interchangeable-parts-specs-table')</script>
<script type="text/javascript">decorateTable('bill-of-materials')</script>
<script type="text/javascript">decorateTable('application_detail')</script>
<script type="text/javascript">decorateTable('service-kits')</script>
<script type="text/javascript">decorateTable('where-used')</script>
<script type="text/javascript">decorateTable('kit-matrix')</script>
